#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CFLAGS_MAINT_APPEND = -g -O2 -fdebug-default-version=4
export DEB_CXXFLAGS_MAINT_APPEND = -g -O2 -fdebug-default-version=4
export DEB_LDFLAGS_MAINT_APPEND = -Wl,-z,relro -Wl,-z,now

%:
	dh $@

override_dh_auto_configure:
	OPENSSL_DIR=$$(ls -1d ../src/openssl-* | grep -v tar.gz | sort -V | tail -n1); \
	echo "Using $$OPENSSL_DIR"; \
        HEADERS_DIR=$$(ls -1d ../src/headers-* | grep -v tar.gz | sort -V | tail -n1); \
        echo "Using $$HEADERS_DIR"; \
	./configure \
	  --prefix=/etc/nginx \
	  --sbin-path=/usr/sbin/nginx \
	  --modules-path=/usr/lib/nginx/modules \
	  --conf-path=/etc/nginx/nginx.conf \
	  --error-log-path=/var/log/nginx/error.log \
	  --http-log-path=/var/log/nginx/access.log \
	  --pid-path=/run/nginx.pid \
	  --lock-path=/run/nginx.lock \
	  --http-client-body-temp-path=/var/cache/nginx/client_temp \
	  --http-proxy-temp-path=/var/cache/nginx/proxy_temp \
	  --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \
	  --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \
	  --http-scgi-temp-path=/var/cache/nginx/scgi_temp \
	  --user=nginx \
	  --group=nginx \
	  --with-http_ssl_module \
	  --with-http_realip_module \
	  --with-http_addition_module \
	  --with-http_sub_module \
	  --with-http_dav_module \
	  --with-http_flv_module \
	  --with-http_mp4_module \
	  --with-http_gunzip_module \
	  --with-http_gzip_static_module \
	  --with-http_random_index_module \
	  --with-http_secure_link_module \
	  --with-http_stub_status_module \
	  --with-http_auth_request_module \
	  --with-http_xslt_module=dynamic \
	  --with-http_image_filter_module=dynamic \
	  --with-http_geoip_module=dynamic \
          --with-http_perl_module=dynamic \
          --with-perl_modules_path=/usr/share/perl5 \
	  --with-threads \
	  --with-stream \
	  --with-stream_ssl_module \
	  --with-stream_ssl_preread_module \
	  --with-stream_realip_module \
	  --with-stream_geoip_module=dynamic \
	  --with-http_slice_module \
	  --with-mail \
	  --with-mail_ssl_module \
	  --with-compat \
	  --with-file-aio \
	  --with-http_v2_module \
	  --with-http_v3_module \
	  --with-openssl=$$OPENSSL_DIR \
	  --with-openssl-opt='enable-ktls enable-async no-shared no-tests no-docs' \
	  --add-module=../src/ngx_brotli \
	  --add-module=$$HEADERS_DIR \
	  --add-module=../src/njs/nginx \
	  --add-module=../src/zstd-nginx-module \
          --with-cc-opt='-g -O2 -flto=auto -ffat-lto-objects -flto=auto -ffat-lto-objects -I /usr/src/quickjs' \
          --with-ld-opt='-Wl,-Bsymbolic-functions -flto=auto -ffat-lto-objects -flto=auto -L /usr/src/quickjs'

override_dh_auto_build:
	dh_auto_build
